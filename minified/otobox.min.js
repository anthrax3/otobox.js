(function(m,h){"function"===typeof define&&define.amd?define([],h):m.otobox=h()})(this,function(){function m(a){return this._options.namingPrefix+a}function h(a){for(var b=0;b<this._activators.length;b++){var c=this._activators[b];if(c.name==a)return c}return null}function v(a){var b=null;if("string"==typeof a.key)try{b=RegExp(a.key)}catch(c){k.call(this,c.message)}else"object"==typeof a.key&&a.key instanceof RegExp?b=a.key:error.call(this,"Unable to match the entered character against activator key.");
return b}function w(){if(null!=this._currentActivator){var a=this._currentActivator,b=null;"string"==typeof a.sourceType?b=a.sourceType:"object"==typeof a.source?a.source instanceof Array&&(b="array"):"string"==typeof a.source&&(b="xhr");if(null!=b){if("function"==typeof r.prototype[b+"Source"])return r.prototype[b+"Source"];k.call(this,'No source with name "'+(b+"Source")+'" found.')}else k.call(this,"Activator's source is unknown.")}else k.call(this,"Current activator is empty.")}function E(){var a=
this._wrapper.querySelectorAll("ul."+(this._options.namingPrefix+"choices")+" > li");if(null!=a&&0<a.length)for(var b=0;b<a.length;b++)a[b].parentNode.removeChild(a[b])}function x(){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")),b=a.querySelector("."+(this._options.namingPrefix+"hint"));null!=b&&b.parentNode.removeChild(b);t.call(this,this._options.useText?a.textContent:a.innerHTML)}function u(a,b,c){a=s(c.templates.choice,{otobox_key:a,otobox_activator:c.name});
a=s(a,b);b=document.createElement("div");b.innerHTML=a;b=b.firstChild;b.setAttribute("data-choice",b.textContent);return b}function y(a){var b=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")),c=document.getSelection(),d=u.call(this,this._stackActivator,a,this._currentActivator);a=document.createTextNode("\u00a0");c.getRangeAt(0).insertNode(a);c.getRangeAt(0).insertNode(d);d=document.createRange();d.setStart(a,1);d.collapse(!0);c.removeAllRanges();c.addRange(d);l.call(this,
this._modes.normal);g.call(this,!1);t.call(this,this._options.useText?b.textContent:b.innerHTML)}function z(a){var b=this;""!=this._stack&&(/loading/.test(this._wrapper.className)||(this._wrapper.className+=" "+(this._options.namingPrefix+"loading")),a.call(this,this._currentActivator,this._stack,this._options,function(a){var d=b._currentActivator;if(null!=d)if(b._sourceResult=a,E.call(b),"object"==typeof a&&a instanceof Array){var e=b._wrapper.querySelector("ul."+m.call(b,"choices"));if(0<a.length)for(var f=
0;f<a.length;f++){var n=a[f],p=document.createElement("li"),l=s(d.templates.suggestion,n),g=document.createElement("div");g.innerHTML=l;var h=g.firstChild;(function(a){h.onclick=function(){x.call(b);y.call(b,a)}})(n);p.appendChild(h);e.appendChild(p)}else p=document.createElement("li"),a=document.createElement("span"),a.className=m.call(b,"empty"),a.textContent="No result",p.appendChild(a),e.appendChild(p)}else k.call(b,"Source returned bad data type.");b._wrapper.className=b._wrapper.className.replace(RegExp(m.call(b,
"loading")),"").trim()}))}function g(a){a=!!a;var b=this._wrapper;b.className=b.className.replace(/otobox-active/gi,"").trim();!0===a&&(b.className+=" otobox-active")}function l(a){if(a==this._modes.normal){this._stackActivator=this._stack="";this._currentMode=this._modes.normal;if(null!=this._currentActivator)if(this._currentActivator.customChoice){if(a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")).querySelector("."+(this._options.namingPrefix+"hint")),null!=a){var b=
q.call(this,a.textContent),b=u.call(this,b.activatorKey,{otobox_value:b.hintText},b.activator);a.parentNode.insertBefore(b,a);a.parentNode.removeChild(a)}}else if(a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")).querySelector("."+(this._options.namingPrefix+"hint")),null!=a){b=document.createTextNode(a.textContent);a.parentNode.insertBefore(b,a);a.parentNode.removeChild(a);var c=document.getSelection(),d=document.createRange();d.setStart(b,a.textContent.length);c.removeAllRanges();
c.addRange(d)}this._currentActivator=null}else a==this._modes.insert&&(this._stackActivator=this._stack="",this._currentMode=this._modes.insert)}function t(a){var b=this._targetObject;"undefined"!=typeof b.value?b.value=a:b.textContent=a}function q(a){if(0<this._activators.length){var b=a[0];a=a.substr(1,a.length-1);for(var c=0;c<this._activators.length;c++){var d=this._activators[c];if(d.key.test(b)&&d.allowedChars.test(a))return{activator:d,activatorKey:b,hintText:a}}}return null}function A(a,b){var c=
document.createElement("span");c.className=this._options.namingPrefix+"hint";c.setAttribute("data-activator",b.name);c.textContent=a;var d=document.getSelection();d.getRangeAt(0).insertNode(c);var e=document.createRange();e.setStart(c,1);d.removeAllRanges();d.addRange(e);return c}function F(a){if(this._currentMode==this._modes.normal){var b=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv"));a=document.getSelection().getRangeAt(0);if(a.startContainer.parentNode!=b)a=void 0;
else{for(var b=3==a.startContainer.nodeType?a.startContainer.textContent:b.textContent,c="",d=a.startOffset-1;0<=d;d--){var e=b[d];if(/\s/.test(e))break;c=e+c}for(var f="",d=a.startOffset;d<b.length;d++){e=b[d];if(/\s/.test(e))break;f+=e}a=q.call(this,c+f)}null!=a&&(l.call(this,this._modes.insert),this._currentActivator=a.activator,this._stackActivator=a.activatorKey,this._stack=a.hintText,a=A.call(this,this._stackActivator+this._stack,a.activator).previousSibling,3==a.nodeType&&(a.textContent=a.textContent.replace(this._stackActivator+
this._stack,"")))}}function G(a){var b;a:{b=String.fromCharCode(a.which);if(0<this._activators.length)for(var c=0;c<this._activators.length;c++){var d=this._activators[c];if(v.call(this,d).test(b)){b=d;break a}}b=null}c=document.getSelection().focusNode;this._currentMode==this._modes.normal&&null!=b&&/\s/.test(c.textContent[document.getSelection().focusOffset-1])?(l.call(this,this._modes.insert),this._currentActivator=b,this._stackActivator=String.fromCharCode(a.which),A.call(this,String.fromCharCode(a.which),
b),a.preventDefault()):this._currentMode==this._modes.insert&&/hint/.test(c.parentNode.className)&&(this._currentActivator.allowedChars.test(String.fromCharCode(a.which))?(this._stack+=String.fromCharCode(a.which),a=w.call(this),z.call(this,a),g.call(this,!0)):(l.call(this,this._modes.normal),g.call(this,!1)))}function H(a){var b=document.getSelection().focusNode;if(this._currentMode==this._modes.normal&&null!=b&&b.parentNode.hasAttribute("data-choice")){var c=b.parentNode;if(/\s/.test(String.fromCharCode(a.which))){var d=
document.getSelection(),b=d.getRangeAt(0).startOffset,e="";c.textContent.length==b?e="\u00a0":(e=c.textContent.substr(0,b).trim(),b=c.textContent.substr(b,c.textContent.length),c.textContent=e,e="\u00a0"+b);b=document.createTextNode(e);c.parentNode.insertBefore(b,c.nextSibling);e=document.createRange();e.setStart(b,1);e.collapse(!0);d.removeAllRanges();d.addRange(e);c.textContent=c.textContent.trim()}b=h.call(this,c.getAttribute("data-activator"));b.customChoice&&(b=q.call(this,c.textContent),null!=
b&&(c.setAttribute("data-value",b.hintText),c.setAttribute("data-choice",b.activatorKey+b.hintText)))}c=this._wrapper.querySelectorAll("*[data-choice]");for(d=0;d<c.length;d++){var f=c[d],b=h.call(this,f.getAttribute("data-activator"));if(!q.call(this,f.textContent)||!b.customChoice&&f.getAttribute("data-choice")!=f.textContent){var n=document.createTextNode(f.textContent),g=document.getSelection(),b=g.getRangeAt(0).startOffset,e=document.createRange();f.parentNode.insertBefore(n,f);f.parentNode.removeChild(f);
!/\s/.test(String.fromCharCode(a.which))&&n.textContent.length>=b&&(e.setStart(n,b),e.collapse(!0),g.removeAllRanges(),g.addRange(e))}}}function I(){if(this._currentMode==this._modes.insert){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")+" ."+(this._options.namingPrefix+"hint"));if(null==a||""==a.textContent||a.textContent==this._stackActivator)l.call(this,this._modes.normal),g.call(this,!1)}}function J(){if(this._currentMode==this._modes.insert){var a=w.call(this);
z.call(this,a);g.call(this,!0)}}function K(){if(this._currentMode==this._modes.insert){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")+" ."+(this._options.namingPrefix+"hint"));if(null!=a){var b=a.getAttribute("data-activator");h.call(this,b);a=q.call(this,a.textContent);null!=a&&(this._stack=a.hintText)}}}function B(a,b){if(this._currentMode==this._modes.insert){var c=this._wrapper.querySelector("."+(this._options.namingPrefix+"active"));null!=c?(c.className="",c=
b?c.previousSibling:c.nextSibling):c=b?this._wrapper.querySelector("ul."+(this._options.namingPrefix+"choices")+" > li:last-child"):this._wrapper.querySelector("ul."+(this._options.namingPrefix+"choices")+" > li:first-child");null!=c&&(c.className=this._options.namingPrefix+"active");a.preventDefault()}}function L(a,b){for(var c=this._sourceResult,d=0;d<c.length;d++){var e=c[d];if(e[b.valueKey]==a)return e}}function M(a){var b=this,c=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv"));
c.onkeypress=function(a){F.call(b,a);G.call(b,a)};c.onkeydown=function(a){38==a.keyCode&&B.call(b,a,!0);40==a.keyCode&&B.call(b,a,!1);if(13==a.keyCode){if(b._currentMode==b._modes.insert){var c=b._wrapper.querySelector("li."+m.call(b,"active")+" a");if(null!=c)return c=L.call(b,c.getAttribute("data-value"),b._currentActivator),x.call(b),y.call(b,c),a.preventDefault(),!1}if("input"==b._targetObject.nodeName.toLowerCase())return a.preventDefault(),!1}C.call(b,"update",[b,a])};c.onkeyup=function(a){H.call(b,
a);t.call(b,b._options.useText?c.textContent:c.innerHTML);if(46==a.keyCode||8==a.keyCode)K.call(b),J.call(b),I.call(b);if(37==a.keyCode||39==a.keyCode)l.call(b,b._modes.normal),g.call(b,!1);32==a.keyCode&&(l.call(b,b._modes.normal),g.call(b,!1));27==a.keyCode&&(l.call(b,b._modes.normal),g.call(b,!1),a.stopPropagation(),a.preventDefault())}}function k(a){throw Error("otobox - "+a);}function s(a,b){return a.replace(/{{(\w+)}}/g,function(a,d){return"undefined"!=typeof b[d]?b[d]:a})}function D(a,b){for(var c=
0;c<a.length;c++){var d=a[c];d.otobox_value=d[b.valueKey]}return a}function C(a,b){if("undefined"!=typeof this._events[a])for(var c=0;c<this._events[a].length;c++)this._events[a][c].apply(this,b)}var r=function(a){this._options={valueKey:"value",namingPrefix:"otobox-",useText:!0,templates:{suggestion:'<a href="javascript:void(0);" data-value="{{otobox_value}}">{{display}}</a>',choice:'<a data-value="{{otobox_value}}" data-key="{{otobox_key}}" data-activator="{{otobox_activator}}" data-choice="" class="otobox-choiceItem">{{otobox_key}}{{display}}</a>'}};
this._activators=[];this._stackActivator=this._stack="";this._modes={normal:0,insert:1};this._currentMode=this._modes.normal;this._sourceResult=this._wrapper=this._currentActivator=null;this._events={};var b=null;"object"==typeof a?b=a:"string"==typeof a?(a=document.querySelector(a),null!=a?b=a:k.call(this,"Unable to find the target object with the given CSS selector.")):k.call(this,"Unable to initiate with the given parameter for init.");if(null!=b){this._targetObject=b;var c=b.getBoundingClientRect();
a=this._wrapper=document.createElement("div");a.className=this._options.namingPrefix+"wrapper";""!=b.className&&(a.className+=" "+b.className);b.parentNode.insertBefore(a,b);b.className+=" "+(this._options.namingPrefix+"input");a.appendChild(b);var d=document.createElement("div");d.setAttribute("name",this._options.namingPrefix+"editableDiv");d.setAttribute("contenteditable",!0);d.setAttribute("data-placeholder",b.placeholder);d.className=this._options.namingPrefix+"editableDiv";a.style.width=c.width+
"px";"textarea"==b.nodeName.toLowerCase()?(d.className+=" "+(this._options.namingPrefix+"textarea-target"),a.style.height=c.height+"px"):d.className+=" "+(this._options.namingPrefix+"input-target");a.appendChild(d);c=document.createElement("ul");c.className=this._options.namingPrefix+"choices";a.appendChild(c);c=document.createElement("div");c.className=this._options.namingPrefix+"loadingElement";a.appendChild(c);M.call(this,b)}else k.call(this,"targetObject is empty.")};r.prototype={setOption:function(a,
b){this._options[a]=b;return this},setOptions:function(a){var b=this._options,c={},d;for(d in b)c[d]=b[d];for(d in a)c[d]=a[d];this._options=c;return this},addActivator:function(a){null!=a?"undefined"!=typeof a.key&&"undefined"!=typeof a.source&&"undefined"!=typeof a.name?(a.allowedChars=a.allowedChars||/.+/,a.tempKey=a.key,a.key=v.call(this,a),a.customChoice=!!a.customChoice,a.valueKey=a.valueKey||this._options.valueKey,"object"!=typeof a.templates&&(a.templates=this._options.templates),this._activators.push(a)):
k.call(this,"Name, key and source fields are mandatory for activator object."):k.call(this,"Activator object is empty.");return this},addChoice:function(a,b){var c=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")),d=h.call(this,a),d=u.call(this,d.tempKey,b,d);c.appendChild(d);return this},getChoices:function(){for(var a={},b=this._wrapper.querySelectorAll("."+(this._options.namingPrefix+"editableDiv")+" *[data-choice]"),c=0;c<b.length;c++){var d=b[c],e=d.getAttribute("data-activator");
"undefined"==typeof a[e]&&(a[e]=[]);a[e].push(d.getAttribute("data-value"))}return a},bind:function(a,b){"undefined"==typeof this._events[a]&&(this._events[a]=[]);this._events[a].push(b);return this},trigger:function(a,b){C.call(this,a,b);return this},arraySource:function(a,b,c,d){c=[];for(var e=0;e<a.source.length;e++){var f=a.source[e];if(RegExp(b,"gi").test(f)){var g={};g.value=f;g.display=f;c.push(g)}}d.call(this,D.call(this,c,a))},xhrSource:function(a,b,c,d){var e=this,f=new XMLHttpRequest;f.open("GET",
s(a.source,{keyword:b}),!0);f.onreadystatechange=function(){if(4==f.readyState&&200==f.status){var b=JSON.parse(f.responseText);"function"==typeof a.postFetch&&(b=a.postFetch.call(e,b));d.call(e,D.call(e,b,a))}};f.send()}};return r});
