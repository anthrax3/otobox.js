(function(n,k){"function"===typeof define&&define.amd?define([],k):n.otobox=k()})(this,function(){function n(a){return this._options.namingPrefix+a}function k(a){for(var b=0;b<this._activators.length;b++){var c=this._activators[b];if(c.name==a)return c}return null}function u(a){var b=null;if("string"==typeof a.key)try{b=RegExp(a.key)}catch(c){h.call(this,c.message)}else"object"==typeof a.key&&a.key instanceof RegExp?b=a.key:error.call(this,"Unable to match the entered character against activator key.");
return b}function v(){if(null!=this._currentActivator){var a=this._currentActivator,b=null;"string"==typeof a.sourceType?b=a.sourceType:"object"==typeof a.source?a.source instanceof Array&&(b="array"):"string"==typeof a.source&&(b="xhr");if(null!=b){if("function"==typeof p.prototype[b+"Source"])return p.prototype[b+"Source"];h.call(this,'No source with name "'+(b+"Source")+'" found.')}else h.call(this,"Activator's source is unknown.")}else h.call(this,"Current activator is empty.")}function F(){var a=
this._wrapper.querySelectorAll("ul."+(this._options.namingPrefix+"choices")+" > li");if(null!=a&&0<a.length)for(var b=0;b<a.length;b++)a[b].parentNode.removeChild(a[b])}function w(){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")),b=a.querySelector("."+(this._options.namingPrefix+"hint"));null!=b&&b.parentNode.removeChild(b);r.call(this,this._options.useText?a.textContent:a.innerHTML)}function s(a,b,c){a=q(c.templates.choice,{otobox_key:a,otobox_activator:c.name});
a=q(a,b);b=document.createElement("div");b.innerHTML=t(a);b=b.firstChild;b.setAttribute("data-choice",b.textContent);return b}function x(a){var b=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")),c=document.getSelection(),d=s.call(this,this._stackActivator,a,this._currentActivator);a=document.createTextNode("\u00a0");c.getRangeAt(0).insertNode(a);c.getRangeAt(0).insertNode(d);d=document.createRange();d.setStart(a,1);d.collapse(!0);c.removeAllRanges();c.addRange(d);g.call(this,
this._modes.normal);l.call(this,!1);r.call(this,this._options.useText?b.textContent:b.innerHTML)}function y(a){var b=this;""!=this._stack&&(/loading/.test(this._wrapper.className)||(this._wrapper.className+=" "+(this._options.namingPrefix+"loading")),a.call(this,this._currentActivator,this._stack,this._options,function(a){var d=b._currentActivator;if(null!=d)if(b._sourceResult=a,F.call(b),"object"==typeof a&&a instanceof Array){var e=b._wrapper.querySelector("ul."+n.call(b,"choices"));if(0<a.length)for(var f=
0;f<a.length;f++){var z=a[f],g=document.createElement("li"),k=q(d.templates.suggestion,z),l=document.createElement("div");l.innerHTML=k;var m=l.firstChild;(function(a){m.onclick=function(){w.call(b);x.call(b,a)}})(z);g.appendChild(m);e.appendChild(g)}else g=document.createElement("li"),g.innerHTML=t(d.templates.noResult),e.appendChild(g)}else h.call(b,"Source returned bad data type.");b._wrapper.className=b._wrapper.className.replace(RegExp(n.call(b,"loading")),"").trim()}))}function l(a){a=!!a;var b=
this._wrapper;b.className=b.className.replace(/otobox-active/gi,"").trim();!0===a&&(b.className+=" otobox-active")}function g(a,b){if(a==this._modes.normal){this._stackActivator=this._stack="";this._currentMode=this._modes.normal;l.call(this,!1);if(null!=this._currentActivator&&!b)if(this._currentActivator.customChoice){var c=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")).querySelector("."+(this._options.namingPrefix+"hint"));if(null!=c){var d=m.call(this,c.textContent),
d=s.call(this,d.activatorKey,{otobox_value:d.hintText},d.activator);c.parentNode.insertBefore(d,c);c.parentNode.removeChild(c)}}else A.call(this);this._currentActivator=null}else a==this._modes.insert&&(this._stackActivator=this._stack="",this._currentMode=this._modes.insert)}function A(){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")).querySelector("."+(this._options.namingPrefix+"hint"));if(null!=a){var b=document.createTextNode(a.textContent);a.parentNode.insertBefore(b,
a);a.parentNode.removeChild(a);var c=document.getSelection(),d=document.createRange();d.setStart(b,a.textContent.length);c.removeAllRanges();c.addRange(d)}}function r(a){var b=this._targetObject;"undefined"!=typeof b.value?b.value=a:b.textContent=a}function m(a){if(0<this._activators.length){var b=a[0];a=a.substr(1,a.length-1);for(var c=0;c<this._activators.length;c++){var d=this._activators[c];if(d.key.test(b)&&d.allowedChars.test(a))return{activator:d,activatorKey:b,hintText:a}}}return null}function B(a,
b){var c=t(document.createElement("span"));c.className=this._options.namingPrefix+"hint";c.setAttribute("data-activator",b.name);c.textContent=a;var d=document.getSelection();d.getRangeAt(0).insertNode(c);var e=document.createRange();e.setStart(c,1);d.removeAllRanges();d.addRange(e);return c}function G(a){if(this._currentMode==this._modes.normal){var b=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv"));a=document.getSelection().getRangeAt(0);if(a.startContainer.parentNode!=
b)a=void 0;else{for(var b=3==a.startContainer.nodeType?a.startContainer.textContent:b.textContent,c="",d=a.startOffset-1;0<=d;d--){var e=b[d];if(/\s/.test(e))break;c=e+c}for(var f="",d=a.startOffset;d<b.length;d++){e=b[d];if(/\s/.test(e))break;f+=e}a=m.call(this,c+f)}if(null!=a){g.call(this,this._modes.insert);this._currentActivator=a.activator;this._stackActivator=a.activatorKey;this._stack=a.hintText;a=B.call(this,this._stackActivator+this._stack,a.activator);if(3==a.previousSibling.nodeType){d=
a.previousSibling.textContent;for(b=d.length;0<=b;b--){c=d[b];if(/\s/.test(c))break;d=d.substr(0,b)}a.previousSibling.textContent=d}if(3==a.nextSibling.nodeType){d=a.nextSibling.textContent;e=d.length;for(b=1;b<=e;b++){c=d[0];if(/\s/.test(c))break;d=d.substr(1,e)}a.nextSibling.textContent=d}}}}function H(a){var b;a:{b=String.fromCharCode(a.which);if(0<this._activators.length)for(var c=0;c<this._activators.length;c++){var d=this._activators[c];if(u.call(this,d).test(b)){b=d;break a}}b=null}c=document.getSelection();
d=c.focusNode;"Range"==c.type?(A.call(this),g.call(this,this._modes.normal,!0)):this._currentMode==this._modes.normal&&null!=b&&/\s/.test(d.textContent[document.getSelection().focusOffset-1])?(g.call(this,this._modes.insert),this._currentActivator=b,this._stackActivator=String.fromCharCode(a.which),B.call(this,String.fromCharCode(a.which),b),a.preventDefault()):this._currentMode==this._modes.insert&&/hint/.test(d.parentNode.className)&&(this._currentActivator.allowedChars.test(String.fromCharCode(a.which))?
(this._stack+=String.fromCharCode(a.which),a=v.call(this),y.call(this,a),l.call(this,!0)):(g.call(this,this._modes.normal),l.call(this,!1)))}function I(a){var b=document.getSelection().focusNode;if(this._currentMode==this._modes.normal&&null!=b&&b.parentNode.hasAttribute("data-choice")){var c=b.parentNode;if(/\s/.test(String.fromCharCode(a.which))){var d=document.getSelection(),b=d.getRangeAt(0).startOffset,e="";c.textContent.length==b?e="\u00a0":(e=c.textContent.substr(0,b).trim(),b=c.textContent.substr(b,
c.textContent.length),c.textContent=e,e="\u00a0"+b);b=document.createTextNode(e);c.parentNode.insertBefore(b,c.nextSibling);e=document.createRange();e.setStart(b,1);e.collapse(!0);d.removeAllRanges();d.addRange(e);c.textContent=c.textContent.trim()}b=k.call(this,c.getAttribute("data-activator"));b.customChoice&&(b=m.call(this,c.textContent),null!=b&&(c.setAttribute("data-value",b.hintText),c.setAttribute("data-choice",b.activatorKey+b.hintText)))}c=this._wrapper.querySelectorAll("*[data-choice]");
for(d=0;d<c.length;d++){var f=c[d],b=k.call(this,f.getAttribute("data-activator"));if(!m.call(this,f.textContent)||!b.customChoice&&f.getAttribute("data-choice")!=f.textContent){var g=document.createTextNode(f.textContent),h=document.getSelection(),b=h.getRangeAt(0).startOffset,e=document.createRange();f.parentNode.insertBefore(g,f);f.parentNode.removeChild(f);!/\s/.test(String.fromCharCode(a.which))&&g.textContent.length>=b&&(e.setStart(g,b),e.collapse(!0),h.removeAllRanges(),h.addRange(e))}}}function J(){if(this._currentMode==
this._modes.insert){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")+" ."+(this._options.namingPrefix+"hint"));if(null==a||""==a.textContent||a.textContent==this._stackActivator)g.call(this,this._modes.normal),l.call(this,!1)}}function K(){if(this._currentMode==this._modes.insert){var a=v.call(this);y.call(this,a);l.call(this,!0)}}function L(){if(this._currentMode==this._modes.insert){var a=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")+
" ."+(this._options.namingPrefix+"hint"));if(null!=a){var b=a.getAttribute("data-activator");k.call(this,b);a=m.call(this,a.textContent);null!=a&&(this._stack=a.hintText)}}}function C(a,b){if(this._currentMode==this._modes.insert){var c=this._wrapper.querySelector("."+(this._options.namingPrefix+"active"));null!=c?(c.className="",c=b?c.previousSibling:c.nextSibling):c=b?this._wrapper.querySelector("ul."+(this._options.namingPrefix+"choices")+" > li:last-child"):this._wrapper.querySelector("ul."+(this._options.namingPrefix+
"choices")+" > li:first-child");null!=c&&(c.className=this._options.namingPrefix+"active");a.preventDefault()}}function M(a,b){for(var c=this._sourceResult,d=0;d<c.length;d++){var e=c[d];if(e[b.valueKey]==a)return e}}function N(){for(var a=this._wrapper.querySelectorAll("."+(this._options.namingPrefix+"editableDiv")+" > *:not([data-otobox])"),b=0;b<a.length;b++){var c=a[b];c.parentNode.insertBefore(document.createTextNode(c.textContent),c);c.parentNode.removeChild(c)}}function O(a){var b=this,c=this._wrapper.querySelector("."+
(this._options.namingPrefix+"editableDiv"));c.onkeypress=function(a){G.call(b,a);H.call(b,a)};c.onkeydown=function(a){38==a.keyCode&&C.call(b,a,!0);40==a.keyCode&&C.call(b,a,!1);if(13==a.keyCode){if(b._currentMode==b._modes.insert){var c=b._wrapper.querySelector("li."+n.call(b,"active")+" a");if(null!=c)return c=M.call(b,c.getAttribute("data-value"),b._currentActivator),w.call(b),x.call(b,c),a.preventDefault(),!1}if("input"==b._targetObject.nodeName.toLowerCase())return a.preventDefault(),!1}D.call(b,
"update",[b,a])};c.onkeyup=function(a){I.call(b,a);N.call(b);r.call(b,b._options.useText?c.textContent:c.innerHTML);if(46==a.keyCode||8==a.keyCode)L.call(b),K.call(b),J.call(b);37!=a.keyCode&&39!=a.keyCode||g.call(b,b._modes.normal);32==a.keyCode&&g.call(b,b._modes.normal);27==a.keyCode&&(g.call(b,b._modes.normal),a.stopPropagation(),a.preventDefault())}}function h(a){throw Error("otobox - "+a);}function q(a,b){return a.replace(/{{(\w+)}}/g,function(a,d){return"undefined"!=typeof b[d]?b[d]:a})}function t(a){var b=
document.createElement("div");b.innerHTML="object"==typeof a?a.outerHTML:a;b=b.firstChild;b.setAttribute("data-otobox","true");return"object"==typeof a?b:b.outerHTML}function E(a,b){for(var c=0;c<a.length;c++){var d=a[c];d.otobox_value=d[b.valueKey]}return a}function D(a,b){if("undefined"!=typeof this._events[a])for(var c=0;c<this._events[a].length;c++)this._events[a][c].apply(this,b)}var p=function(a){this._options={valueKey:"value",namingPrefix:"otobox-",useText:!0,templates:{suggestion:'<a href="javascript:void(0);" data-value="{{otobox_value}}">{{display}}</a>',
noResult:'<span class="otobox-empty">No result</span>',choice:'<a data-value="{{otobox_value}}" data-key="{{otobox_key}}" data-activator="{{otobox_activator}}" data-choice="" class="otobox-choiceItem">{{otobox_key}}{{display}}</a>'}};this._activators=[];this._stackActivator=this._stack="";this._modes={normal:0,insert:1};this._currentMode=this._modes.normal;this._sourceResult=this._wrapper=this._currentActivator=null;this._events={};var b=null;"object"==typeof a?b=a:"string"==typeof a?(a=document.querySelector(a),
null!=a?b=a:h.call(this,"Unable to find the target object with the given CSS selector.")):h.call(this,"Unable to initiate with the given parameter for init.");if(null!=b){this._targetObject=b;var c=b.getBoundingClientRect();a=this._wrapper=document.createElement("div");a.className=this._options.namingPrefix+"wrapper";""!=b.className&&(a.className+=" "+b.className);b.parentNode.insertBefore(a,b);b.className+=" "+(this._options.namingPrefix+"input");a.appendChild(b);var d=document.createElement("div");
d.setAttribute("name",this._options.namingPrefix+"editableDiv");d.setAttribute("contenteditable",!0);d.setAttribute("data-placeholder",b.placeholder);d.className=this._options.namingPrefix+"editableDiv";a.style.width=c.width+"px";"textarea"==b.nodeName.toLowerCase()?(d.className+=" "+(this._options.namingPrefix+"textarea-target"),a.style.height=c.height+"px"):d.className+=" "+(this._options.namingPrefix+"input-target");a.appendChild(d);c=document.createElement("ul");c.className=this._options.namingPrefix+
"choices";a.appendChild(c);c=document.createElement("div");c.className=this._options.namingPrefix+"loadingElement";a.appendChild(c);O.call(this,b)}else h.call(this,"targetObject is empty.")};p.prototype={setOption:function(a,b){this._options[a]=b;return this},setOptions:function(a){var b=this._options,c={},d;for(d in b)c[d]=b[d];for(d in a)c[d]=a[d];this._options=c;return this},addActivator:function(a){null!=a?"undefined"!=typeof a.key&&"undefined"!=typeof a.source&&"undefined"!=typeof a.name?(a.allowedChars=
a.allowedChars||/.+/,a.tempKey=a.key,a.key=u.call(this,a),a.customChoice=!!a.customChoice,a.valueKey=a.valueKey||this._options.valueKey,"object"!=typeof a.templates&&(a.templates=this._options.templates),this._activators.push(a)):h.call(this,"Name, key and source fields are mandatory for activator object."):h.call(this,"Activator object is empty.");return this},addChoice:function(a,b){var c=this._wrapper.querySelector("."+(this._options.namingPrefix+"editableDiv")),d=k.call(this,a),d=s.call(this,
d.tempKey,b,d);c.appendChild(d);return this},getChoices:function(){for(var a={},b=this._wrapper.querySelectorAll("."+(this._options.namingPrefix+"editableDiv")+" *[data-choice]"),c=0;c<b.length;c++){var d=b[c],e=d.getAttribute("data-activator");"undefined"==typeof a[e]&&(a[e]=[]);a[e].push(d.getAttribute("data-value"))}return a},bind:function(a,b){"undefined"==typeof this._events[a]&&(this._events[a]=[]);this._events[a].push(b);return this},trigger:function(a,b){D.call(this,a,b);return this},arraySource:function(a,
b,c,d){c=[];for(var e=0;e<a.source.length;e++){var f=a.source[e];if(RegExp(b,"gi").test(f)){var g={};g.value=f;g.display=f;c.push(g)}}d.call(this,E.call(this,c,a))},xhrSource:function(a,b,c,d){var e=this,f=new XMLHttpRequest;f.open("GET",q(a.source,{keyword:b}),!0);f.onreadystatechange=function(){if(4==f.readyState&&200==f.status){var b=JSON.parse(f.responseText);"function"==typeof a.postFetch&&(b=a.postFetch.call(e,b));d.call(e,E.call(e,b,a))}};f.send()}};return p});
